#!/usr/bin/env python3

import sys
import datetime
import platform
import pathlib

links = {
    "jj/config.toml"        : "~/.config/jj/config.toml",
    "ghostty-config"        : "~/.config/ghostty/config",
    "emacs/my-dot-emacs.el" : "~/.emacs.el",
    "emacs/my-early-init.el": "~/.emacs.d/early-init.el",
    # "bash/bashrc"           : "~/.bashrc",
    "git/gitconfig"         : "~/.gitconfig",
    "ripgreprc"             : "~/.ripgreprc",
    "sqliterc"              : "~/.sqliterc",
    "pythonrc.py"           : "~/.pythonrc",
    "zsh/zshrc"             : "~/.zshrc",
    "visidata/visidatarc"   : "~/.visidatarc",
    "sublime/prefs.json"    : {
        "Linux" : "~/.config/sublime-text-3/Packages/User/Preferences.sublime-settings",
        "Darwin": "~/Library/Application Support/Sublime Text 3/Packages/User/Preferences.sublime-settings"
    }.get(platform.system())
}

def user_proceeds(prompt):
    if input(f"{prompt} ").strip() in ("y",):
        return True
    else:
        return False

def main():
    only_new = user_proceeds("only new?")

    timestamp = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
    dotdir = pathlib.Path(__file__).resolve().parents[1]
    user_home = str(pathlib.Path.home())

    def try_pretty_name(path):
        path = str(path)
        if path.startswith(user_home):
            path = path.removeprefix(user_home)
            path = "~" + path
        return path

    for (src, dest) in links.items():
        print(f"{src}:")

        if dest is None:
            print(f"  has no dest...skipping")
            continue
        dest = pathlib.Path(dest).expanduser()
        if not dest.parent.exists():
            print(f"  parent directory {try_pretty_name(dest.parent)} does not exist...skipping")
            continue

        if dest.exists():
            if only_new:
                print(f"  {try_pretty_name(dest)} exists but only new is asked so skipping")
                # if dest already exists, but only the new one is asked for, we skip it
                continue
            else:
                bkp = dest.with_name(f"{dest.name}.{timestamp}.bkp")
                print(f"  renaming existing {try_pretty_name(dest)} to {try_pretty_name(bkp)}")
                if user_proceeds("Rename(y/n)?"):
                    dest.rename(bkp)

        print(f"  symlinking as {try_pretty_name(dest)}")
        if user_proceeds("Symlink(y/n)?"):
            dest.symlink_to(dotdir.joinpath(src))
        print()

if __name__ == "__main__":
    main()
