#!/usr/bin/env python3

import sys
import datetime
from pathlib import Path
import platform

def main(actual_run):
    files_to_link = {
        "~/.emacs.el"  : "emacs/my-dot-emacs.el",
        "~/.bashrc"    : "bash/bashrc",
        "~/.gitconfig" : "git/gitconfig",
        "~/.ripgreprc" : "ripgreprc",
   }

    sublime_config_path = {
        "Linux": "~/.config/sublime-text-3/Packages/User/Preferences.sublime-settings",
        "Darwin": "~/Library/Application Support/Sublime Text 3/Packages/User/Preferences.sublime-settings"
    }.get(platform.system())

    if sublime_config_path:
        files_to_link[sublime_config_path] = "sublime/prefs.json"

    timestamp = datetime.datetime.now().strftime("%Y%m%d_%H%M%S")
    my_dot_dir = Path(__file__).resolve().parents[1]

    for (global_dot_raw, my_dot_raw) in files_to_link.items():
        global_dot = Path(global_dot_raw).expanduser()
        my_dot = my_dot_dir.joinpath(my_dot_raw)
        needs_backup = global_dot.exists()

        if needs_backup:
            dot_backup_path = dot.with_name(f"{dot.name}.{timestamp}.bkp")
            if actual_run:
                dot.rename(dot_backup_path)

        if actual_run:
            dot.symlink_to(my_dot)

        msg = [my_dot_name, dot_name]
        if needs_backup:
            msg.append(dot_backup_path.name)
        msg = ' => '.join(msg)
        print(msg)

if __name__ == "__main__":
    main("-f" in sys.argv[1:])
